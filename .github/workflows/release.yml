name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  prepare:
    runs-on: ubuntu-22.04
    outputs:
      release_version: ${{ steps.version.outputs.release_version }}
    steps:
      - name: Resolve release version
        id: version
        shell: bash
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME#v}"
          if [[ -z "${version}" ]]; then
            echo "Failed to resolve release version from tag: ${GITHUB_REF_NAME}" >&2
            exit 1
          fi
          echo "release_version=${version}" >> "$GITHUB_OUTPUT"

  build_windows:
    runs-on: windows-latest
    needs: prepare
    env:
      RELEASE_VERSION: ${{ needs.prepare.outputs.release_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m venv .venv
          .\.venv\Scripts\python.exe -m pip install --upgrade pip
          .\.venv\Scripts\python.exe -m pip install -r requirements.txt
          .\.venv\Scripts\python.exe -m pip install -r requirements-dev.txt

      - name: Install Inno Setup
        shell: pwsh
        run: choco install innosetup --yes

      - name: Build portable EXE
        shell: pwsh
        run: .\packaging\build_portable.ps1

      - name: Build installer EXE
        shell: pwsh
        env:
          INNO_SETUP_COMPILER: C:\Program Files (x86)\Inno Setup 6\ISCC.exe
        run: .\packaging\build_installer.ps1

      - name: Verify Windows artifacts
        shell: pwsh
        run: |
          $portable = "dist/ArchiveCord-v$env:RELEASE_VERSION-win64-portable.exe"
          $setup = "dist_installer/ArchiveCord-v$env:RELEASE_VERSION-win64-setup.exe"
          if (!(Test-Path $portable)) { throw "Missing artifact: $portable" }
          if (!(Test-Path $setup)) { throw "Missing artifact: $setup" }

      - name: Stage Windows release artifacts
        shell: pwsh
        run: |
          $portable = "dist/ArchiveCord-v$env:RELEASE_VERSION-win64-portable.exe"
          $setup = "dist_installer/ArchiveCord-v$env:RELEASE_VERSION-win64-setup.exe"
          New-Item -ItemType Directory -Path "release-flat" -Force | Out-Null
          Copy-Item $portable "release-flat/ArchiveCord-v$env:RELEASE_VERSION-win64-portable.exe" -Force
          Copy-Item $setup "release-flat/ArchiveCord-v$env:RELEASE_VERSION-win64-setup.exe" -Force

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-windows
          if-no-files-found: error
          path: release-flat/*

  build_macos:
    runs-on: macos-latest
    needs: prepare
    env:
      RELEASE_VERSION: ${{ needs.prepare.outputs.release_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python3 -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Build macOS artifacts
        shell: bash
        run: |
          set -euo pipefail
          bash ./packaging/build_macos.sh "${RELEASE_VERSION}"

      - name: Smoke test macOS app bundle
        shell: bash
        run: |
          set -euo pipefail
          source .venv/bin/activate
          python - <<'PY'
          import os
          import subprocess
          import sys
          import time

          binary = "dist/ArchiveCord.app/Contents/MacOS/ArchiveCord"
          if not os.path.exists(binary):
              raise SystemExit(f"Missing app binary: {binary}")

          env = dict(os.environ)
          env["QT_QPA_PLATFORM"] = "offscreen"
          proc = subprocess.Popen([binary], env=env, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
          time.sleep(6)
          code = proc.poll()
          if code is not None and code != 0:
              out, err = proc.communicate(timeout=5)
              sys.stderr.write(err.decode("utf-8", "ignore"))
              sys.stderr.write(out.decode("utf-8", "ignore"))
              raise SystemExit(f"macOS bundle exited early with code {code}")
          proc.terminate()
          try:
              proc.wait(timeout=5)
          except subprocess.TimeoutExpired:
              proc.kill()
          PY

      - name: Verify macOS artifacts
        shell: bash
        run: |
          set -euo pipefail
          test -f "dist/ArchiveCord-v${RELEASE_VERSION}-macos-universal.dmg"
          test -f "dist/ArchiveCord-v${RELEASE_VERSION}-macos-universal.zip"

      - name: Stage macOS release artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release-flat
          cp "dist/ArchiveCord-v${RELEASE_VERSION}-macos-universal.dmg" "release-flat/ArchiveCord-v${RELEASE_VERSION}-macos-universal.dmg"
          cp "dist/ArchiveCord-v${RELEASE_VERSION}-macos-universal.zip" "release-flat/ArchiveCord-v${RELEASE_VERSION}-macos-universal.zip"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-macos
          if-no-files-found: error
          path: release-flat/*

  build_linux:
    runs-on: ubuntu-22.04
    needs: prepare
    env:
      RELEASE_VERSION: ${{ needs.prepare.outputs.release_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux runtime deps
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y libglib2.0-0 libgl1 libegl1 libdbus-1-3 libxkbcommon-x11-0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python3 -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Build Linux artifacts
        shell: bash
        run: |
          set -euo pipefail
          bash ./packaging/build_linux.sh "${RELEASE_VERSION}"

      - name: Smoke test Linux binaries
        shell: bash
        run: |
          set -euo pipefail
          .venv/bin/python - <<'PY'
          import os
          import subprocess
          import sys
          import time

          def smoke(binary: list[str], extra_env: dict[str, str] | None = None) -> None:
              env = dict(os.environ)
              env["QT_QPA_PLATFORM"] = "offscreen"
              if extra_env:
                  env.update(extra_env)
              proc = subprocess.Popen(binary, env=env, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
              time.sleep(6)
              code = proc.poll()
              if code is not None and code != 0:
                  out, err = proc.communicate(timeout=5)
                  sys.stderr.write(err.decode("utf-8", "ignore"))
                  sys.stderr.write(out.decode("utf-8", "ignore"))
                  raise SystemExit(f"Process exited early with code {code}: {' '.join(binary)}")
              proc.terminate()
              try:
                  proc.wait(timeout=5)
              except subprocess.TimeoutExpired:
                  proc.kill()

          smoke(["dist/ArchiveCord/ArchiveCord"])
          smoke(["dist/ArchiveCord-v" + os.environ["RELEASE_VERSION"] + "-linux-x86_64.AppImage"], {"APPIMAGE_EXTRACT_AND_RUN": "1"})
          PY

      - name: Verify Linux artifacts
        shell: bash
        run: |
          set -euo pipefail
          test -f "dist/ArchiveCord-v${RELEASE_VERSION}-linux-x86_64.AppImage"
          test -f "dist/ArchiveCord-v${RELEASE_VERSION}-linux-x86_64.tar.gz"

      - name: Stage Linux release artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release-flat
          cp "dist/ArchiveCord-v${RELEASE_VERSION}-linux-x86_64.AppImage" "release-flat/ArchiveCord-v${RELEASE_VERSION}-linux-x86_64.AppImage"
          cp "dist/ArchiveCord-v${RELEASE_VERSION}-linux-x86_64.tar.gz" "release-flat/ArchiveCord-v${RELEASE_VERSION}-linux-x86_64.tar.gz"

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-linux
          if-no-files-found: error
          path: release-flat/*

  publish:
    runs-on: ubuntu-22.04
    needs:
      - prepare
      - build_windows
      - build_macos
      - build_linux
    env:
      RELEASE_VERSION: ${{ needs.prepare.outputs.release_version }}
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-*
          merge-multiple: true
          path: release-assets

      - name: Verify release payload
        shell: bash
        run: |
          set -euo pipefail
          required=(
            "ArchiveCord-v${RELEASE_VERSION}-win64-portable.exe"
            "ArchiveCord-v${RELEASE_VERSION}-win64-setup.exe"
            "ArchiveCord-v${RELEASE_VERSION}-macos-universal.dmg"
            "ArchiveCord-v${RELEASE_VERSION}-macos-universal.zip"
            "ArchiveCord-v${RELEASE_VERSION}-linux-x86_64.AppImage"
            "ArchiveCord-v${RELEASE_VERSION}-linux-x86_64.tar.gz"
          )
          for file in "${required[@]}"; do
            if [[ ! -f "release-assets/${file}" ]]; then
              echo "Missing release asset: release-assets/${file}" >&2
              exit 1
            fi
          done
          ls -lh release-assets

      - name: Publish GitHub release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-assets/ArchiveCord-v${{ env.RELEASE_VERSION }}-win64-portable.exe
            release-assets/ArchiveCord-v${{ env.RELEASE_VERSION }}-win64-setup.exe
            release-assets/ArchiveCord-v${{ env.RELEASE_VERSION }}-macos-universal.dmg
            release-assets/ArchiveCord-v${{ env.RELEASE_VERSION }}-macos-universal.zip
            release-assets/ArchiveCord-v${{ env.RELEASE_VERSION }}-linux-x86_64.AppImage
            release-assets/ArchiveCord-v${{ env.RELEASE_VERSION }}-linux-x86_64.tar.gz
          fail_on_unmatched_files: true

      - name: Notes for future signing
        shell: bash
        run: |
          echo "Code signing and notarization are intentionally not enforced in this workflow."
          echo "Future extension points:"
          echo " - Windows signing step after build_windows"
          echo " - macOS notarization/signing step after build_macos"
